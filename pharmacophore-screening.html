<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Multi-Parameter Pharmacophore Screening (Offline, No-API)
    Author: Samvit Govindani
    Purpose: Educational, portfolio-ready demo for pharmacophore-based screening
             with multi-parameter scoring (Binding, ADME heuristic, Toxicity alerts)
             and polished 3D UX. No external APIs. Safe for GitHub Pages.
    License: MIT (include LICENSE file in repo)
    Disclaimer: Not for clinical use. Educational simulator only.
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi-Parameter Pharmacophore Screening (Offline)</title>

  <!-- Tailwind for clean UI (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- three.js core + OrbitControls (r128) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.min.js" defer></script>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: light; }
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .canvas-container { background:#111827; border-radius:0.75rem; }
    .score-card { background: linear-gradient(145deg, #ffffff, #ececec); transition: transform .15s ease, box-shadow .15s ease; }
    .score-card:hover { transform: translateY(-4px); box-shadow: 0 10px 18px rgba(0,0,0,.08); }
    .feature-card { transition: transform .15s ease, box-shadow .15s ease; }
    .feature-card.matched { background:#10b981; color:#fff; transform:scale(1.04); box-shadow:0 0 14px rgba(16,185,129,.45); }
    .hit-list-row { cursor:pointer; transition: background-color .15s ease; }
    .hit-list-row:hover { background:#2563eb; color:#fff; }
    .loader{ border:4px solid #e5e7eb;border-top:4px solid #3b82f6;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    @media (prefers-reduced-motion: reduce){
      .feature-card,.score-card{transition:none}
      .loader{animation:none}
    }
    footer { opacity:.85 }
  </style>
</head>
<body class="text-gray-800">
  <div class="container mx-auto p-4 max-w-7xl">
    <!-- Header -->
    <header class="text-center my-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Multi-Parameter Pharmacophore Screening</h1>
      <p class="text-gray-600 mt-2">Offline, educational simulator for binding, drug-likeness, and safety ‚Äî with 3D visualization.</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT: Controls & Hits -->
      <aside class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-6">
        <!-- Target legend auto-filled -->
        <section>
          <h2 class="text-xl font-bold mb-2">Target Active Site</h2>
          <div id="target-features-list" class="space-y-2"></div>
        </section>

        <hr/>

        <!-- Controls -->
        <section>
          <h2 class="text-xl font-bold mb-3">Screening Controls</h2>
          <div class="grid grid-cols-2 gap-2">
            <!-- New candidate -->
            <button id="screen-btn" aria-label="Screen new candidate" class="col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform hover:scale-105 shadow-md">
              üß¨ Screen New Candidate
            </button>
            <!-- Optimize current -->
            <button id="optimize-btn" aria-label="Optimize current lead" class="col-span-2 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition-transform hover:scale-105 shadow-md hidden">
              üß™ Optimize Lead
            </button>
            <!-- Seed toggle -->
            <button id="toggle-seed-btn" aria-label="Toggle seeded randomness" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded">
              Seeded RNG: ON
            </button>
            <!-- Snapshot -->
            <button id="snapshot-btn" aria-label="Download canvas snapshot" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-3 rounded">
              üì∏ Snapshot
            </button>
            <!-- Export -->
            <button id="export-btn" aria-label="Export hits JSON" class="bg-gray-700 text-white hover:bg-gray-800 font-semibold py-2 px-3 rounded">
              ‚¨áÔ∏è Export Hits
            </button>
            <!-- Import -->
            <label class="bg-gray-700 text-white hover:bg-gray-800 font-semibold py-2 px-3 rounded text-center cursor-pointer">
              ‚¨ÜÔ∏è Import Hits
              <input id="import-input" type="file" accept="application/json" class="hidden" />
            </label>
            <!-- Clear -->
            <button id="clear-btn" aria-label="Clear hits" class="bg-red-600 text-white hover:bg-red-700 font-semibold py-2 px-3 rounded">
              üßπ Clear
            </button>
          </div>

          <!-- Spinner -->
          <div id="loader-container" class="hidden flex items-center justify-center mt-4">
            <div class="loader"></div>
            <p class="ml-3 text-gray-600">Running pipeline‚Ä¶</p>
          </div>
        </section>

        <hr/>

        <!-- Hit list -->
        <section>
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-bold">üèÜ Hit List (Top 5)</h2>
            <span class="text-xs text-gray-500">by Composite Score</span>
          </div>
          <div id="hit-list-container" class="space-y-2">
            <p class="text-sm text-gray-500 text-center py-4">No hits recorded yet.</p>
          </div>
        </section>
      </aside>

      <!-- RIGHT: 3D + Results -->
      <main class="lg:col-span-2 space-y-6">
        <!-- 3D scene -->
        <div class="bg-white p-4 rounded-xl shadow-lg">
          <div id="canvas-container" class="w-full h-96 md:h-[520px] relative canvas-container">
            <div class="absolute top-2 left-2 bg-black bg-opacity-50 px-2 py-1 rounded text-white text-xs">
              Drag to rotate ‚Ä¢ Scroll to zoom
            </div>
          </div>
        </div>

        <!-- Results -->
        <div id="results-panel" class="bg-white p-6 rounded-xl shadow-lg hidden">
          <h2 class="text-2xl font-bold mb-4">Candidate Analysis</h2>

          <!-- Score cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="score-card p-4 rounded-lg border text-center">
              <h3 class="font-semibold text-gray-500">Binding Affinity</h3>
              <p id="score-binding" class="text-4xl font-extrabold text-blue-600">0</p>
            </div>
            <div class="score-card p-4 rounded-lg border text-center">
              <h3 class="font-semibold text-gray-500">Drug-Likeness</h3>
              <p id="score-adme" class="text-4xl font-extrabold text-emerald-600">0</p>
            </div>
            <div class="score-card p-4 rounded-lg border text-center">
              <h3 class="font-semibold text-gray-500">Safety</h3>
              <p id="score-toxicity" class="text-4xl font-extrabold text-amber-600">0</p>
            </div>
            <div class="score-card p-4 rounded-lg border-2 border-indigo-600 text-center bg-indigo-50">
              <h3 class="font-semibold text-indigo-800">Composite</h3>
              <p id="score-composite" class="text-4xl font-extrabold text-indigo-700">0</p>
            </div>
          </div>

          <!-- Binding diagnostics -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <section class="lg:col-span-1">
              <h3 class="font-semibold text-lg mb-2">Binding Summary</h3>
              <p id="binding-interpretation" class="text-sm text-gray-600 mb-1">‚Äî</p>
              <p id="match-count" class="text-xs text-gray-500">‚Äî</p>
            </section>
            <section class="lg:col-span-2">
              <h3 class="font-semibold text-lg mb-2">Per-Feature Contributions</h3>
              <div id="contrib-list" class="space-y-2"></div>
            </section>
          </div>

          <!-- Ligand features (matched highlight) -->
          <section class="mt-6">
            <h3 class="font-semibold text-lg mb-2">Ligand Feature Analysis</h3>
            <div id="ligand-features-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
          </section>

          <!-- Local offline report -->
          <section class="mt-6">
            <h3 class="font-semibold text-lg mb-2">Auto-Generated Analysis (Local)</h3>
            <div id="report-output" class="text-gray-700 bg-gray-100 p-4 rounded-md text-sm leading-relaxed min-h-[100px]">
              <p class="text-gray-500">Click ‚ÄúScreen New Candidate‚Äù to generate a report.</p>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Disclaimer -->
    <footer class="text-xs text-gray-500 text-center mt-8">
      Educational simulator ‚Äî not for clinical use. Provided ‚ÄúAS IS‚Äù without warranty. See MIT License.
    </footer>
  </div>

  <script>
    // ==========================
    //  Pharmacophore Catalog
    // ==========================
    // Feature types with labels/colors. Add weights if you want to bias contributions later.
    const PHARMACOPHORE_FEATURES = {
      H_DONOR:       { name: "H-Bond Donor",    color: 0x42a5f5 },
      H_ACCEPTOR:    { name: "H-Bond Acceptor", color: 0xef5350 },
      HYDROPHOBIC:   { name: "Hydrophobic",     color: 0xffca28 },
      AROMATIC:      { name: "Aromatic Ring",   color: 0xec4899 },
      POSITIVE_ION:  { name: "Positive Ion",    color: 0x66bb6a },
      NEGATIVE_ION:  { name: "Negative Ion",    color: 0xab47bc }
    };

    // Fixed target pharmacophore (demo pocket)
    const TARGET_PHARMACOPHORE = [
      { type: 'H_ACCEPTOR',   position: new THREE.Vector3(-4,  2,  0) },
      { type: 'HYDROPHOBIC',  position: new THREE.Vector3( 3, -3,  2) },
      { type: 'AROMATIC',     position: new THREE.Vector3( 5,  5, -1) },
      { type: 'POSITIVE_ION', position: new THREE.Vector3(-2, -5, -3) }
    ];

    // Simple "toxicophore" alerts (toy rules for educational use)
    const TOXICOPHORES = [
      { features: ['AROMATIC', 'NEGATIVE_ION'], reason: "Planar aromatic system with anionic group ‚Üí potential intercalation." },
      { features: ['HYDROPHOBIC', 'HYDROPHOBIC', 'HYDROPHOBIC'], reason: "Excessive lipophilicity ‚Üí non-specific binding risk." }
    ];

    // ==========================
    //  Scene & Global State
    // ==========================
    let scene, camera, renderer, controls;
    const targetGroup = new THREE.Group();
    const ligandGroup = new THREE.Group();
    const auxGroup    = new THREE.Group();
    const pocketBox   = new THREE.Box3(); // AABB expanded around target features

    let currentLigandFeatures = []; // array of {type, position:Vector3, matched}
    let topHits = [];               // top-5 by composite score
    let seeded = true;              // reproducibility toggle
    let rng = mulberry32(1337);     // default seed for deterministic runs

    // ==========================
    //  Seeded RNG (mulberry32)
    // ==========================
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }
    function rand()         { return seeded ? rng() : Math.random(); }
    function randInt(a, b)  { return Math.floor(rand() * (b - a + 1)) + a; }
    function randRange(a, b){ return a + (b - a) * rand(); }

    // ==========================
    //  Three.js Initialization
    // ==========================
    function init3D() {
      const container = document.getElementById('canvas-container');
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 0, 24);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setClearColor(0x111827);
      if (THREE.sRGBEncoding) renderer.outputEncoding = THREE.sRGBEncoding;
      container.appendChild(renderer.domElement);

      // Lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
      dirLight.position.set(6, 10, 7.5);
      scene.add(dirLight);

      // Controls (orbit/zoom/pinch)
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 8;
      controls.maxDistance = 80;

      // Subtle XY grid for orientation
      const grid = new THREE.GridHelper(60, 30, 0x334155, 0x1f2937);
      grid.rotation.x = Math.PI / 2;
      grid.position.z = -12;
      auxGroup.add(grid);

      scene.add(targetGroup, ligandGroup, auxGroup);

      // Target pocket & legend
      drawTargetPharmacophore();

      // Resize observer
      window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      }, { passive: true });

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls && controls.update();
      renderer.render(scene, camera);
    }

    // ==========================
    //  Render Target Pocket
    // ==========================
    function drawTargetPharmacophore() {
      targetGroup.clear();
      const legend = document.getElementById('target-features-list');
      legend.innerHTML = '';
      pocketBox.makeEmpty();

      TARGET_PHARMACOPHORE.forEach(f => {
        const def = PHARMACOPHORE_FEATURES[f.type];
        const geom = new THREE.TorusKnotGeometry(1.5, 0.25, 72, 10);
        const mat  = new THREE.MeshStandardMaterial({ color: def.color, roughness: 0.35, metalness: 0.2 });
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.copy(f.position);
        targetGroup.add(mesh);

        pocketBox.expandByPoint(f.position);

        const card = document.createElement('div');
        card.className = "flex items-center bg-gray-100 p-2 rounded-md";
        card.innerHTML = `<div class="w-4 h-4 rounded-full mr-3" style="background-color:#${def.color.toString(16).padStart(6,'0')}"></div>
                          <span class="font-medium">${def.name}</span>`;
        legend.appendChild(card);
      });

      // Expand AABB by padding and visualize it
      pocketBox.expandByScalar(3.0);
      const helper = new THREE.Box3Helper(pocketBox, 0x00ffff);
      targetGroup.add(helper);
    }

    // ==========================
    //  Render Ligand
    // ==========================
    function drawLigand(features) {
      ligandGroup.clear();

      // Semi-transparent "core"
      const coreGeom = new THREE.IcosahedronGeometry(1.1, 0);
      const coreMat  = new THREE.MeshStandardMaterial({ color: 0x9e9e9e, transparent: true, opacity: 0.22, roughness: 0.8, metalness: 0.05 });
      ligandGroup.add(new THREE.Mesh(coreGeom, coreMat));

      // Feature spheres
      features.forEach(feat => {
        const def = PHARMACOPHORE_FEATURES[feat.type];
        const geom = new THREE.SphereGeometry(0.75, 32, 32);
        const mat  = new THREE.MeshStandardMaterial({ color: def.color, roughness: 0.5, metalness: 0.1 });
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.copy(feat.position);
        ligandGroup.add(mesh);
      });
    }

    // ==========================
    //  Generation & Optimization
    // ==========================
    // Random ligand: 4‚Äì7 features inside a cube around the pocket
    function generateRandomLigand() {
      const n = randInt(4, 7);
      const keys = Object.keys(PHARMACOPHORE_FEATURES);
      const features = [];
      for (let i = 0; i < n; i++) {
        const type = keys[randInt(0, keys.length - 1)];
        const pos = new THREE.Vector3(randRange(-6, 6), randRange(-6, 6), randRange(-6, 6));
        features.push({ type, position: pos, matched: false });
      }
      return features;
    }

    // Local "optimize": small positional nudges
    function optimizeLigand(base) {
      return base.map(f => {
        const p = f.position.clone();
        p.x += randRange(-1.2, 1.2);
        p.y += randRange(-1.2, 1.2);
        p.z += randRange(-1.2, 1.2);
        return { ...f, position: p, matched: false };
      });
    }

    // ==========================
    //  Scoring
    // ==========================
    // Binding: match same-type features within pocket; distance threshold ‚Üí contribution (max 25/feature)
    function scoreBinding(ligandFeatures) {
      ligandFeatures.forEach(f => f.matched = false);
      const threshold = 3.5;
      let score = 0;
      let matches = 0;
      const contributions = []; // per-target

      TARGET_PHARMACOPHORE.forEach(t => {
        let bestDist = Infinity, bestIdx = -1;

        ligandFeatures.forEach((l, idx) => {
          if (l.type !== t.type || l.matched === true) return;
          if (!pocketBox.containsPoint(l.position)) return;
          const d = t.position.distanceTo(l.position);
          if (d < bestDist) { bestDist = d; bestIdx = idx; }
        });

        if (bestIdx >= 0 && bestDist < threshold) {
          const contrib = (threshold - bestDist) / threshold * 25; // 0..25
          score += contrib;
          matches += 1;
          ligandFeatures[bestIdx].matched = true;
          contributions.push({ target: t.type, distance: bestDist, contribution: contrib });
        } else {
          contributions.push({ target: t.type, distance: null, contribution: 0 });
        }
      });

      score = Math.max(0, Math.min(100, score)); // clamp
      return { score, contributions, matches };
    }

    // ADME heuristic: toy ‚ÄúRule of Five‚Äù approximation from feature counts (educational only)
    function scoreADME(ligandFeatures) {
      const mwApprox = ligandFeatures.length * 80; // rough placeholder
      const hDonors  = ligandFeatures.filter(f => f.type === 'H_DONOR').length;
      const hAccept  = ligandFeatures.filter(f => f.type === 'H_ACCEPTOR').length;

      let score = 100;
      if (mwApprox > 500) score -= 40;
      if (hDonors  > 5)   score -= 30;
      if (hAccept  > 10)  score -= 30;
      return Math.max(0, Math.min(100, score));
    }

    // Toxicity alerts: check presence of simple ‚Äútoxicophore‚Äù patterns
    function scoreToxicity(ligandFeatures) {
      const types = ligandFeatures.map(f => f.type);
      let reason = null;
      for (const tox of TOXICOPHORES) {
        // Check if all required features are present (counts not strict here)
        let ok = true;
        const counts = {};
        types.forEach(t => counts[t] = (counts[t] || 0) + 1);
        // verify multi-occurrences if listed multiple times
        const needed = {};
        tox.features.forEach(t => needed[t] = (needed[t] || 0) + 1);
        for (const k in needed) {
          if (!counts[k] || counts[k] < needed[k]) { ok = false; break; }
        }
        if (ok) { reason = tox.reason; break; }
      }
      // 100 = pass, 0 = flagged (educational, not real tox)
      return { score: reason ? 0 : 100, reason };
    }

    // Composite: weights can be tuned (here Binding 0.5, ADME 0.3, Safety 0.2)
    function compositeScore(binding, adme, tox) {
      return 0.5 * binding + 0.3 * adme + 0.2 * tox;
    }

    // ==========================
    //  UI Helpers
    // ==========================
    function bindingInterpretation(s) {
      if (s > 70) return "Excellent match ‚Äî high potential for binding.";
      if (s > 40) return "Good match ‚Äî meaningful binding potential.";
      if (s > 15) return "Fair match ‚Äî partial feature alignment.";
      return "Poor match ‚Äî unlikely to bind.";
    }

    function renderContributions(contribs) {
      const box = document.getElementById('contrib-list');
      box.innerHTML = '';
      contribs.forEach(c => {
        const def = PHARMACOPHORE_FEATURES[c.target];
        const widthPct = Math.min(100, (c.contribution / 25) * 100);
        const distText = c.distance !== null ? `${c.distance.toFixed(2)} √Ö` : "‚Äî";
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="flex justify-between text-sm">
            <span class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full" style="background-color:#${def.color.toString(16).padStart(6,'0')}"></span>
              <span class="font-medium">${def.name}</span>
            </span>
            <span class="text-gray-600">${distText}</span>
          </div>
          <div class="w-full bg-gray-200 rounded h-2 mt-1">
            <div class="h-2 rounded" style="width:${widthPct}%; background-color:#${def.color.toString(16).padStart(6,'0')}"></div>
          </div>
        `;
        box.appendChild(row);
      });
    }

    function renderLigandCards(features) {
      const list = document.getElementById('ligand-features-list');
      list.innerHTML = '';
      features.forEach(f => {
        const def = PHARMACOPHORE_FEATURES[f.type];
        const card = document.createElement('div');
        card.className = "feature-card flex items-center bg-gray-100 p-2 rounded-md text-sm";
        if (f.matched) card.classList.add('matched');
        card.innerHTML = `<div class="w-3 h-3 rounded-full mr-2" style="background-color:#${def.color.toString(16).padStart(6,'0')}"></div>
                          <span class="font-medium">${def.name}</span>`;
        list.appendChild(card);
      });
    }

    function renderScores(binding, adme, tox, comp, matches) {
      document.getElementById('results-panel').classList.remove('hidden');
      document.getElementById('score-binding').textContent  = binding.toFixed(0);
      document.getElementById('score-adme').textContent     = adme.toFixed(0);
      document.getElementById('score-toxicity').textContent = tox.toFixed(0);
      document.getElementById('score-composite').textContent= comp.toFixed(0);
      document.getElementById('binding-interpretation').textContent = bindingInterpretation(binding);
      document.getElementById('match-count').textContent = `${matches} / ${TARGET_PHARMACOPHORE.length} target features matched`;
      // Show optimize if binding is at least moderate
      document.getElementById('optimize-btn').classList.toggle('hidden', binding < 40);
    }

    // Local, deterministic textual report (no network)
    function localReport(scores, featureTypes, toxReason) {
      const pot = scores.binding >= 70 ? "strong" : scores.binding >= 40 ? "moderate" : "weak";
      const adm = scores.adme    >= 80 ? "favorable" : scores.adme >= 50 ? "acceptable" : "unfavorable";
      const saf = toxReason ? `flagged: ${toxReason}` : "no common alerts detected";
      const next = scores.composite >= 70 ? "advance to optimization"
                : scores.composite >= 50 ? "retain with modifications"
                : "deprioritize";
      return (
        `<b>Candidate Profile</b>: ${featureTypes.join(", ")}<br>` +
        `<b>Binding</b>: ${scores.binding.toFixed(0)}/100 (${pot})<br>` +
        `<b>ADME</b>: ${scores.adme.toFixed(0)}/100 (${adm})<br>` +
        `<b>Safety</b>: ${scores.toxicity.toFixed(0)}/100 (${saf})<br>` +
        `<b>Overall</b>: Composite ${scores.composite.toFixed(0)}/100 ‚Üí <b>${next}</b>.`
      );
    }

    // ==========================
    //  Hits Management
    // ==========================
    function updateHitList(compScore, features, matches) {
      const minScore = topHits.length < 5 ? -1 : topHits[4].score;
      if (compScore > minScore) {
        const cloned = features.map(f => ({ type: f.type, position: f.position.clone(), matched: f.matched }));
        topHits.push({ score: compScore, features: cloned, meta: { matches, timestamp: Date.now() } });
        topHits.sort((a, b) => b.score - a.score);
        if (topHits.length > 5) topHits.pop();
        renderHitList();
      }
    }

    function renderHitList() {
      const container = document.getElementById('hit-list-container');
      container.innerHTML = '';
      if (topHits.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hits recorded yet.</p>';
        return;
      }
      topHits.forEach((hit, idx) => {
        const row = document.createElement('div');
        row.className = 'hit-list-row flex justify-between items-center bg-gray-100 p-2 rounded-md';
        row.dataset.index = idx;
        row.innerHTML = `
          <span class="font-semibold">#${idx + 1}</span>
          <span class="font-bold text-blue-600">${hit.score.toFixed(0)}</span>
          <span class="text-xs text-gray-500 hidden md:inline">${new Date(hit.meta.timestamp).toLocaleTimeString()}</span>
          <button class="text-xs bg-gray-700 text-white px-2 py-1 rounded">Load</button>
        `;
        container.appendChild(row);
      });
    }

    function exportHits() {
      const json = JSON.stringify(topHits.map(h => ({
        score: h.score,
        matches: h.meta.matches,
        features: h.features.map(f => ({ type: f.type, position: { x: f.position.x, y: f.position.y, z: f.position.z } }))
      })), null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pharmacophore_hits.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function importHits(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error("Invalid format");
          topHits = data.slice(0, 5).map(item => ({
            score: Number(item.score) || 0,
            meta: { matches: Number(item.matches) || 0, timestamp: Date.now() },
            features: (item.features || []).map(f => ({
              type: f.type,
              position: new THREE.Vector3(f.position.x, f.position.y, f.position.z),
              matched: false
            }))
          }));
          topHits.sort((a,b)=>b.score-a.score);
          renderHitList();
        } catch(e) {
          alert("Failed to import: " + e.message);
        }
      };
      reader.readAsText(file);
    }

    // ==========================
    //  Pipeline Runner
    // ==========================
    function runPipeline(ligandGenerator) {
      screenBtn.disabled = true;
      optimizeBtn.disabled = true;
      loader.classList.remove('hidden');

      setTimeout(() => {
        currentLigandFeatures = ligandGenerator();
        drawLigand(currentLigandFeatures);

        // Scores
        const bind = scoreBinding(currentLigandFeatures);
        const adme = scoreADME(currentLigandFeatures);
        const tox  = scoreToxicity(currentLigandFeatures);
        const comp = compositeScore(bind.score, adme, tox.score);

        // UI
        renderScores(bind.score, adme, tox.score, comp, bind.matches);
        renderContributions(bind.contributions);
        renderLigandCards(currentLigandFeatures);

        // Report (offline)
        const types = currentLigandFeatures.map(f => f.type);
        const reportHTML = localReport(
          { binding: bind.score, adme, toxicity: tox.score, composite: comp },
          types,
          tox.reason
        );
        document.getElementById('report-output').innerHTML = reportHTML;

        // Hits
        updateHitList(comp, currentLigandFeatures, bind.matches);

        screenBtn.disabled = false;
        optimizeBtn.disabled = false;
        loader.classList.add('hidden');
      }, 250); // short delay purely for spinner feedback
    }

    // ==========================
    //  Snapshot
    // ==========================
    function snapshotCanvas() {
      const a = document.createElement('a');
      a.download = 'snapshot.png';
      a.href = renderer.domElement.toDataURL('image/png');
      a.click();
    }

    // ==========================
    //  DOM & Events
    // ==========================
    const screenBtn        = document.getElementById('screen-btn');
    const optimizeBtn      = document.getElementById('optimize-btn');
    const loader           = document.getElementById('loader-container');
    const hitListContainer = document.getElementById('hit-list-container');
    const exportBtn        = document.getElementById('export-btn');
    const importInput      = document.getElementById('import-input');
    const clearBtn         = document.getElementById('clear-btn');
    const toggleSeedBtn    = document.getElementById('toggle-seed-btn');
    const snapshotBtn      = document.getElementById('snapshot-btn');

    screenBtn.addEventListener('click', () => runPipeline(generateRandomLigand));
    optimizeBtn.addEventListener('click', () => runPipeline(() => optimizeLigand(currentLigandFeatures)));
    exportBtn.addEventListener('click', exportHits);
    importInput.addEventListener('change', (e) => { if (e.target.files?.[0]) importHits(e.target.files[0]); e.target.value = ''; });
    clearBtn.addEventListener('click', () => { topHits = []; renderHitList(); });
    toggleSeedBtn.addEventListener('click', () => {
      seeded = !seeded;
      if (seeded) rng = mulberry32(1337 + Math.floor(Date.now()/60000)); // rotates hourly for variety
      toggleSeedBtn.textContent = `Seeded RNG: ${seeded ? 'ON' : 'OFF'}`;
    });
    snapshotBtn.addEventListener('click', snapshotCanvas);

    hitListContainer.addEventListener('click', async (e) => {
      const row = e.target.closest('.hit-list-row');
      if (!row) return;
      const index = parseInt(row.dataset.index);
      const hit = topHits[index];
      if (!hit) return;

      // Deep clone features back to current
      currentLigandFeatures = hit.features.map(f => ({ type: f.type, position: f.position.clone(), matched: false }));
      drawLigand(currentLigandFeatures);

      // Recompute diagnostics for loaded hit
      const bind = scoreBinding(currentLigandFeatures);
      const adme = scoreADME(currentLigandFeatures);
      const tox  = scoreToxicity(currentLigandFeatures);
      const comp = compositeScore(bind.score, adme, tox.score);

      renderScores(bind.score, adme, tox.score, comp, bind.matches);
      renderContributions(bind.contributions);
      renderLigandCards(currentLigandFeatures);

      const types = currentLigandFeatures.map(f => f.type);
      document.getElementById('report-output').innerHTML =
        localReport({ binding: bind.score, adme, toxicity: tox.score, composite: comp }, types, tox.reason);
    });

    // Boot
    window.addEventListener('load', () => { init3D(); });
  </script>
</body>
</html>
